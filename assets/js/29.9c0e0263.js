(window.webpackJsonp=window.webpackJsonp||[]).push([[29],{599:function(e,t,n){"use strict";n.r(t);var a=n(55),o=Object(a.a)({},(function(){var e=this,t=e.$createElement,n=e._self._c||t;return n("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[n("h1",{attrs:{id:"php-cakephp-からgooglecloudstorageを利用する"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#php-cakephp-からgooglecloudstorageを利用する"}},[e._v("#")]),e._v(" PHP(CakePHP)からGoogleCloudStorageを利用する")]),e._v(" "),n("h2",{attrs:{id:"前提条件"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#前提条件"}},[e._v("#")]),e._v(" 前提条件")]),e._v(" "),n("ul",[n("li",[e._v("GCP登録済み")]),e._v(" "),n("li",[e._v("GCS登録済み")]),e._v(" "),n("li",[n("a",{attrs:{href:"https://github.com/google/google-api-php-client",target:"_blank",rel:"noopener noreferrer"}},[e._v("google-aapi-php-client"),n("OutboundLink")],1),e._v("を利用")])]),e._v(" "),n("h2",{attrs:{id:"google-api-php-clientの準備"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#google-api-php-clientの準備"}},[e._v("#")]),e._v(" google-api-php-clientの準備")]),e._v(" "),n("p",[e._v("私は今回アプリケーションのルート(appと同階層)のvendorsを使用しました。app/Vendorとどう違うのかよくわかってません。"),n("br"),e._v("\nDLしたクライアントのsrc/Googleをvendorsの下にコピー。"),n("br"),e._v("\napp/Config/bootstrap.phpに以下の行を追加。")]),e._v(" "),n("div",{staticClass:"language-bootstrap.php extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v('require_once(ROOT.DS."vendors/Google/autoload.php");\n')])])]),n("h2",{attrs:{id:"認証"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#認証"}},[e._v("#")]),e._v(" 認証")]),e._v(" "),n("p",[e._v("今回はGoogleCloudStorageを扱うためのモデルをひとつ作成しました。"),n("br"),e._v("\nGoogleDevelopersConsoleの左カラム、APIと認証>認証情報より新しいクライアントIDを作成。"),n("br"),e._v("\n今回はユーザーに認証を求めず、PHPアプリケーション越しの操作となりますのでサービスアカウントを作成。"),n("br"),e._v("\nJSONキーを利用しますのでそちらを選択してください。")]),e._v(" "),n("p",[e._v("参考にしたサイトがこちら："),n("a",{attrs:{href:"http://d.hatena.ne.jp/scientre/20140626/google_analytics_api",target:"_blank",rel:"noopener noreferrer"}},[e._v("メモ用紙"),n("OutboundLink")],1),n("br"),e._v("\n実際に書いたソースが以下。")]),e._v(" "),n("p",[n("strong",[e._v("Storage.php")])]),e._v(" "),n("div",{staticClass:"language-php:Storage.php extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v("    function __construct()\n    {\n        $this->client = new Google_Client();\n        $this->client->setApplicationName('My Application');\n        \n        $this->client->setClientId($this->client_id);\n        $this->client->setAssertionCredentials(new Google_Auth_AssertionCredentials($this->service_account_name, array(\n            Google_Service_Storage::DEVSTORAGE_READ_WRITE\n        ), file_get_contents(ROOT.DS.\"vendors/key/\" . $this->key_file)));\n    }\n")])])]),n("p",[e._v("CakePHPのAppModel継承クラスなのでstaticの使い方はしませんでした。"),n("br"),e._v("\nコントローラからはふつうに"),n("code",[e._v("$this->Storage->get()")]),e._v("とかで使う想定です。")]),e._v(" "),n("h2",{attrs:{id:"ファイルアップロード"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#ファイルアップロード"}},[e._v("#")]),e._v(" ファイルアップロード")]),e._v(" "),n("p",[n("strong",[e._v("Storage.php")])]),e._v(" "),n("div",{staticClass:"language-php:Storage.php extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v("public function upload($filename,$binary)\n    {\n        $contentType=\"\";\n        if(strncmp($binary,'89 50 4E 47',11)){\n            $contentType=\"png\";\n        }else if(strncmp($binary,'FF D8 FF',8)){\n            $contentType=\"jpeg\";\n        }else if(strncmp($binary,'47 49 46 38',11)){\n            $contentType=\"gif\";\n        }else{\n            return false;\n        }\n        \n        // ストレージサービスを作成する\n        $storage = new Google_Service_Storage($this->client);\n        \n        // アップロードするファイル名とデータ\n        $name = $filename.'.'.$contentType;\n        $data = $binary;\n        \n        // ストレージオブジェクトを作成する\n        $obj = new Google_Service_Storage_StorageObject();\n        $obj->setName($name);\n        \n        // アップロードする\n        $result=$storage->objects->insert($this->default_bucket_name, $obj, [\n            'name' => $name,\n            'data' => $data,\n            'uploadType' => 'media',\n            'mimeType' => 'image/'.$contentType,\n            'predefinedAcl' => 'publicread'\n        ]);\n    }\n")])])]),n("p",[e._v("わざわざバイナリ読んで拡張子の判定してるのはちょっとこちらの都合です。"),n("br"),e._v("\n$_FILESそのままもらえるならファイル名の末尾取ればいいと思います。")]),e._v(" "),n("p",[e._v("27行目、$storage->objects->insertの第三引数について。"),n("br"),e._v("\nこの後getメソッドを書いてPHP越しに画像を表示することを目標としていますので、mineTypeとpredefinedAclは設定が必要です。"),n("br"),e._v("\nmineTypeは設定しないと自動でapplication/octet-streamになってしまい、ブラウザで表示できませんでした。")]),e._v(" "),n("p",[e._v("参考："),n("a",{attrs:{href:"http://stackoverflow.com/questions/20060445/cant-set-content-type-to-google-storage-with-the-google-php-client",target:"_blank",rel:"noopener noreferrer"}},[e._v("stackoverflow"),n("OutboundLink")],1)]),e._v(" "),n("h2",{attrs:{id:"ファイル表示"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#ファイル表示"}},[e._v("#")]),e._v(" ファイル表示")]),e._v(" "),n("p",[n("strong",[e._v("Storage.php")])]),e._v(" "),n("div",{staticClass:"language-php:Storage.php extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v('    public function get($name){\n        // ストレージサービスを作成する\n        $storage = new Google_Service_Storage($this->client);\n        \n        // ストレージオブジェクトを作成する\n        $obj = new Google_Service_Storage_StorageObject();\n        \n        // 取得する\n        $data = $storage->objects->get($this->default_bucket_name, $name);\n        \n        // 表示する\n        header("Content-Type:".$data->getContentType());\n        $content=file_get_contents($data->getMediaLink());\n        echo $content;\n    }\n')])])]),n("p",[e._v("ここは割と素直に取得→表示、です。"),n("br"),e._v("\nupload時点でpredefinedAclを指定していない場合、ファイルの一般公開がされていませんので、file_get_contentsができない(権限がない)状態になります。")]),e._v(" "),n("p",[e._v("というわけで以上！"),n("br"),e._v("\n認証部分でハマって"),n("a",{attrs:{href:"http://stackoverflow.com/questions/22079057/getting-unable-to-parse-the-p12-file-error-with-google-api-php-client",target:"_blank",rel:"noopener noreferrer"}},[e._v("stackoverflow"),n("OutboundLink")],1),e._v("見に行った時、コメント3の「俺もそこで2日無駄にした……」みたいなコメントに癒やされました。"),n("br"),e._v("\n当方の場合は、導入したクライアントのバージョンが古かったのが問題でした(´@ω@｀)")])])}),[],!1,null,null,null);t.default=o.exports}}]);