<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>VSCodeの拡張機能を作った | 活動拠点</title>
    <meta name="description" content="活動拠点です。">
    <link rel="icon" type="image/png" href="/blog/assets/img/favicon.ico">
  <meta name="author" content="perpouh">
    
    <link rel="preload" href="/blog/assets/css/0.styles.8603afa1.css" as="style"><link rel="preload" href="/blog/assets/js/app.83bf8f63.js" as="script"><link rel="preload" href="/blog/assets/js/2.7cd08314.js" as="script"><link rel="preload" href="/blog/assets/js/9.2516a79e.js" as="script"><link rel="preload" href="/blog/assets/js/3.09c30569.js" as="script"><link rel="prefetch" href="/blog/assets/js/10.eab17877.js"><link rel="prefetch" href="/blog/assets/js/11.ea0ff966.js"><link rel="prefetch" href="/blog/assets/js/12.36aa079f.js"><link rel="prefetch" href="/blog/assets/js/13.6c1a2057.js"><link rel="prefetch" href="/blog/assets/js/14.3ba1a09b.js"><link rel="prefetch" href="/blog/assets/js/4.c1668b26.js"><link rel="prefetch" href="/blog/assets/js/5.6edf70dd.js"><link rel="prefetch" href="/blog/assets/js/6.e23653b3.js"><link rel="prefetch" href="/blog/assets/js/7.a98e321a.js"><link rel="prefetch" href="/blog/assets/js/8.bae6461a.js">
    <link rel="stylesheet" href="/blog/assets/css/0.styles.8603afa1.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/blog/" class="home-link router-link-active"><img src="/blog/assets/img/logo.png" alt="活動拠点" class="logo"> <span class="site-name can-hide">活動拠点</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/blog/resume/" class="nav-link">ぱあぷう</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/blog/resume/" class="nav-link">ぱあぷう</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>VSCode</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/vscode/kkympreviewer.html" class="active sidebar-link">カクヨムプレビューワ</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/vscode/kkympreviewer.html#変換した文章をどこに表示するか？" class="sidebar-link">変換した文章をどこに表示するか？</a></li><li class="sidebar-sub-header"><a href="/blog/vscode/kkympreviewer.html#どのようにして「現在開いているテキストの内容」を取り出せるか？" class="sidebar-link">どのようにして「現在開いているテキストの内容」を取り出せるか？</a></li><li class="sidebar-sub-header"><a href="/blog/vscode/kkympreviewer.html#いわゆるwatchてきな。" class="sidebar-link">いわゆるwatchてきな。</a></li><li class="sidebar-sub-header"><a href="/blog/vscode/kkympreviewer.html#ついでなので作業ファイルを切り替えたときにもプレビューを更新したい" class="sidebar-link">ついでなので作業ファイルを切り替えたときにもプレビューを更新したい</a></li><li class="sidebar-sub-header"><a href="/blog/vscode/kkympreviewer.html#ちなみに" class="sidebar-link">ちなみに</a></li><li class="sidebar-sub-header"><a href="/blog/vscode/kkympreviewer.html#感想" class="sidebar-link">感想</a></li><li class="sidebar-sub-header"><a href="/blog/vscode/kkympreviewer.html#で、" class="sidebar-link">で、</a></li></ul></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Vue</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="vscodeの拡張機能を作った"><a href="#vscodeの拡張機能を作った" class="header-anchor">#</a> VSCodeの拡張機能を作った</h1> <p>TypeScript初挑戦。</p> <p><a href="https://kakuyomu.jp" target="_blank" rel="noopener noreferrer">カクヨム<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>という小説投稿サイトがある。<br>
ここでは<a href="https://kakuyomu.jp/help/entry/notation" target="_blank" rel="noopener noreferrer">カクヨム記法<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>というものを用いて、ルビや傍点を処理できる。<br>
しかしながら当方にはWeb上で文章の塊を書く趣味はない。文章は必ずローカルで書き、コピーし、Webフォームにペーストして投稿する。さもなくば消える。インターネットに対する信用度が00年代初頭からあまり上がっていないのだと思う。<br>
加えて、このカクヨムのプレビューが割と見づらい。毎度タブを移動する動きになるため、上から下に毎度スクロールしなくてはならない。だるい。めんどくさい。VSCodeでリアルタイムプレビューしたい。</p> <p>益体のない文章を十数万字も書きながらそのちょっとのスクロールを面倒に感じるあたり、そしてそこからよしプログラム書こうとなるあたりがエンジニアなのだと思う。我ながらどう考えても手間暇の価値基準が狂っている。</p> <p>まあでもルビくらいはなんてことない。String.prototype.replaceすればいいだけなので。</p> <p>リポジトリはこちら
<div class="hbc-blog-card"><div class="hbc-link-wrap"><a href="https://github.com/perpouh/kkympreviewer" target="_blank" class="hbc-link"><div class="hbc-card"><div class="hbc-contents"><img src="https://avatars0.githubusercontent.com/u/8610298?s=400&amp;v=4" class="hbc-thumbnail"><div class="hbc-text"><div class="hbc-title">perpouh/kkympreviewer</div><div class="hbc-url">https://github.com/perpouh/kkympreviewer</div><div class="hbc-description">カクヨム記法プレビューワ(VSCode拡張)</div></div></div><div class="hbc-info"><div class="hbc-site-name">github.com</div></div></div></a></div></div></p> <p>まず公式サイトを参考に、プロジェクトの雛形を作ります。<br> <a href="https://code.visualstudio.com/api/get-started/your-first-extension" target="_blank" rel="noopener noreferrer">Your First Extension - Visual Studio Code<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">npm</span> <span class="token function">install</span> -g yo generator-code
</code></pre></div><div class="language-bash extra-class"><pre class="language-bash"><code>yo code

<span class="token comment"># ? What type of extension do you want to create? New Extension (TypeScript)</span>
<span class="token comment"># ? What's the name of your extension? HelloWorld</span>
<span class="token comment">### Press &lt;Enter&gt; to choose default for all options below ###</span>

<span class="token comment"># ? What's the identifier of your extension? helloworld</span>
<span class="token comment"># ? What's the description of your extension? LEAVE BLANK</span>
<span class="token comment"># ? Initialize a git repository? Yes</span>
<span class="token comment"># ? Which package manager to use? npm</span>
</code></pre></div><p>F5を押してデバッグモードを開き、コマンドパレットからハローワールドを実行。動かない。<br>
詰むの早いな？　と思いながら<code>npm install</code>したりVSCodeのアップグレードしたりしたら動きました。あとは愛用している拡張のひとつである<a href="https://github.com/yzhang-gh/vscode-markdown" target="_blank" rel="noopener noreferrer">vscode-markdown<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>のソースを参考にもりもり書きます。</p> <h2 id="変換した文章をどこに表示するか？"><a href="#変換した文章をどこに表示するか？" class="header-anchor">#</a> 変換した文章をどこに表示するか？</h2> <p><a href="https://github.com/yzhang-gh/vscode-markdown" target="_blank" rel="noopener noreferrer">vscode-markdown<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>のコードを読んだ結果、Webviewに表示しているらしいことがわかりました。<a href="https://code.visualstudio.com/api/extension-guides/webview" target="_blank" rel="noopener noreferrer">公式ドキュメントのWebviewの項<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>を見に行くと、可愛い猫ちゃんがキーボードをばしばししていたので集中力とやる気を失いました。靴下猫ちゃんかわいい。</p> <div class="language-TypeScript extra-class"><pre class="language-typescript"><code><span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> vscode <span class="token keyword">from</span> <span class="token string">'vscode'</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">activate</span><span class="token punctuation">(</span><span class="token parameter">context<span class="token operator">:</span> vscode<span class="token punctuation">.</span>ExtensionContext</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  context<span class="token punctuation">.</span>subscriptions<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>
    vscode<span class="token punctuation">.</span>commands<span class="token punctuation">.</span><span class="token function">registerCommand</span><span class="token punctuation">(</span><span class="token string">'catCoding.start'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token comment">// Create and show panel</span>
      <span class="token keyword">const</span> panel <span class="token operator">=</span> vscode<span class="token punctuation">.</span>window<span class="token punctuation">.</span><span class="token function">createWebviewPanel</span><span class="token punctuation">(</span>
        <span class="token string">'catCoding'</span><span class="token punctuation">,</span>
        <span class="token string">'Cat Coding'</span><span class="token punctuation">,</span>
        vscode<span class="token punctuation">.</span>ViewColumn<span class="token punctuation">.</span>One<span class="token punctuation">,</span>
        <span class="token punctuation">{</span><span class="token punctuation">}</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// And set its HTML content</span>
      panel<span class="token punctuation">.</span>webview<span class="token punctuation">.</span>html <span class="token operator">=</span> <span class="token function">getWebviewContent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">getWebviewContent</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;!DOCTYPE html&gt;
&lt;html lang=&quot;en&quot;&gt;
&lt;head&gt;
    &lt;meta charset=&quot;UTF-8&quot;&gt;
    &lt;meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1.0&quot;&gt;
    &lt;title&gt;Cat Coding&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
    &lt;img src=&quot;https://media.giphy.com/media/JIX9t2j0ZTN9S/giphy.gif&quot; width=&quot;300&quot; /&gt;
&lt;/body&gt;
&lt;/html&gt;</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>二十分ほどで気を取り直してWebviewを表示するためのコードをコピペし、表示を確認。OK。HTMLの出し方もわかったので、ここに「今開いているテキスト」の内容を投入します。</p> <h2 id="どのようにして「現在開いているテキストの内容」を取り出せるか？"><a href="#どのようにして「現在開いているテキストの内容」を取り出せるか？" class="header-anchor">#</a> どのようにして「現在開いているテキストの内容」を取り出せるか？</h2> <p><a href="https://github.com/yzhang-gh/vscode-markdown" target="_blank" rel="noopener noreferrer">vscode-markdown<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>の<a href="https://github.com/yzhang-gh/vscode-markdown/blob/master/src/preview.ts" target="_blank" rel="noopener noreferrer">vscode-markdown/src/preview.ts<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>を見ると</p> <div class="language-TypeScript extra-class"><pre class="language-typescript"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">activate</span><span class="token punctuation">(</span><span class="token parameter">context<span class="token operator">:</span> ExtensionContext</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token comment">//(略)</span>
    <span class="token comment">// Try preview when this extension is activated the first time</span>
    <span class="token function">autoPreviewToSide</span><span class="token punctuation">(</span>window<span class="token punctuation">.</span>activeTextEditor<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//(略)</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">autoPreviewToSide</span><span class="token punctuation">(</span><span class="token parameter">editor<span class="token operator">:</span> TextEditor</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token comment">//(略)</span>
    <span class="token keyword">let</span> doc <span class="token operator">=</span> editor<span class="token punctuation">.</span>document<span class="token punctuation">;</span>
<span class="token comment">//(略)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>のような記述があります。これが良いような気がします。引数の型がわかったので<a href="https://code.visualstudio.com/api/references/vscode-api#TextEditor" target="_blank" rel="noopener noreferrer">公式ドキュメントのTextEditorの項<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>を見に行きます。<br>
どうやらwindow.activeTextEditor.document.getText()で「現在開いているテキストの内容」が取れそうです。</p> <p>つまりこう。</p> <div class="language-TypeScript extra-class"><pre class="language-typescript"><code><span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> vscode <span class="token keyword">from</span> <span class="token string">'vscode'</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">activate</span><span class="token punctuation">(</span><span class="token parameter">context<span class="token operator">:</span> vscode<span class="token punctuation">.</span>ExtensionContext</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  context<span class="token punctuation">.</span>subscriptions<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>
    vscode<span class="token punctuation">.</span>commands<span class="token punctuation">.</span><span class="token function">registerCommand</span><span class="token punctuation">(</span><span class="token string">'catCoding.start'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token comment">// Create and show panel</span>
      <span class="token keyword">const</span> panel <span class="token operator">=</span> vscode<span class="token punctuation">.</span>window<span class="token punctuation">.</span><span class="token function">createWebviewPanel</span><span class="token punctuation">(</span>
        <span class="token string">'catCoding'</span><span class="token punctuation">,</span>
        <span class="token string">'Cat Coding'</span><span class="token punctuation">,</span>
        vscode<span class="token punctuation">.</span>ViewColumn<span class="token punctuation">.</span>Two<span class="token punctuation">,</span>  <span class="token comment">// 2カラムにしたかったので変更</span>
        <span class="token punctuation">{</span><span class="token punctuation">}</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">let</span> editor <span class="token operator">=</span> window<span class="token punctuation">.</span>activeTextEditor<span class="token punctuation">;</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>editor<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// editor.addEventListener()</span>
      <span class="token keyword">let</span> doc <span class="token operator">=</span> editor<span class="token punctuation">.</span>document<span class="token punctuation">;</span>
      panel<span class="token punctuation">.</span>webview<span class="token punctuation">.</span>html <span class="token operator">=</span> <span class="token function">getWebviewContent</span><span class="token punctuation">(</span>doc<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">getWebviewContent</span><span class="token punctuation">(</span><span class="token parameter">doc<span class="token operator">:</span> TextDocument</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;!DOCTYPE html&gt;
&lt;html lang=&quot;en&quot;&gt;
&lt;head&gt;
    &lt;meta charset=&quot;UTF-8&quot;&gt;
    &lt;meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1.0&quot;&gt;
    &lt;title&gt;Cat Coding&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
    </span><span class="token template-punctuation string">`</span></span> <span class="token operator">+</span> doc<span class="token punctuation">.</span><span class="token function">getText</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
&lt;/body&gt;
&lt;/html&gt;</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>OK。<br>
これではテキストの取得が一回のみなので、テキストを変更したときにWebview側の表示も変わるようにしましょう。</p> <h2 id="いわゆるwatchてきな。"><a href="#いわゆるwatchてきな。" class="header-anchor">#</a> いわゆるwatchてきな。</h2> <p>おそらく<code>addEventListener</code>みたいな、あるいは<code>watch()</code>のような何かがあるのだろうと検討をつけて探します。探すというかまあ、すぐ下に<a href="https://code.visualstudio.com/api/references/vscode-api#TextDocumentContentChangeEvent" target="_blank" rel="noopener noreferrer">TextDocumentContentChangeEvent<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>という項目があるので探すまでもなくこれです。<br> <code>TextDocumentChangeEvent</code>でページ内検索をすると、どうもこれは<code>workspace</code>から発生してくるらしいことが見えます。</p> <p>つまりこう。</p> <div class="language-TypeScript extra-class"><pre class="language-typescript"><code>    vscode<span class="token punctuation">.</span>workspace<span class="token punctuation">.</span><span class="token function">onDidChangeTextDocument</span><span class="token punctuation">(</span><span class="token parameter">event</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      panel<span class="token punctuation">.</span>webview<span class="token punctuation">.</span>html <span class="token operator">=</span> <span class="token function">getWebviewContent</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>document<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>書きながら「これもしかして作業ファイル切り替えてもおなじWebviewにプレビューされるのでは？と思い試したところ、その通りでした。まあいいか別に。</p> <h2 id="ついでなので作業ファイルを切り替えたときにもプレビューを更新したい"><a href="#ついでなので作業ファイルを切り替えたときにもプレビューを更新したい" class="header-anchor">#</a> ついでなので作業ファイルを切り替えたときにもプレビューを更新したい</h2> <p><a href="https://github.com/yzhang-gh/vscode-markdown" target="_blank" rel="noopener noreferrer">vscode-markdown<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>を見た感じたぶんここでしょう。</p> <div class="language-TypeScript extra-class"><pre class="language-typescript"><code>    window<span class="token punctuation">.</span><span class="token function">onDidChangeActiveTextEditor</span><span class="token punctuation">(</span><span class="token parameter">editor</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token function">autoPreviewToSide</span><span class="token punctuation">(</span>editor<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>これを</p> <div class="language-TypeScript extra-class"><pre class="language-typescript"><code>  vscode<span class="token punctuation">.</span>window<span class="token punctuation">.</span><span class="token function">onDidChangeActiveTextEditor</span><span class="token punctuation">(</span><span class="token parameter">editor</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>editor<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">let</span> doc <span class="token operator">=</span> editor<span class="token punctuation">.</span>document<span class="token punctuation">;</span>
    panel<span class="token punctuation">.</span>webview<span class="token punctuation">.</span>html <span class="token operator">=</span> <span class="token function">getWebviewContent</span><span class="token punctuation">(</span>doc<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>こんな感じ。<br>
現在の<code>panel</code>だとクロージャから読めないので宣言を外に出します。なんかちょっとアンチケースのような気がします。</p> <div class="language-TypeScript extra-class"><pre class="language-typescript"><code><span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> vscode <span class="token keyword">from</span> <span class="token string">'vscode'</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> panel<span class="token operator">:</span> vscode<span class="token punctuation">.</span>WebviewPanel<span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">activate</span><span class="token punctuation">(</span><span class="token parameter">context<span class="token operator">:</span> vscode<span class="token punctuation">.</span>ExtensionContext</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token punctuation">(</span>以下略<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>これで無事、作業ファイルを切り替えたときにもプレビューを更新することができました。</p> <h2 id="ちなみに"><a href="#ちなみに" class="header-anchor">#</a> ちなみに</h2> <p>あんまり面白くないので触れていませんが、ルビと傍点の処理は</p> <div class="language-TypeScript extra-class"><pre class="language-typescript"><code><span class="token keyword">function</span> <span class="token function">convertToHtml</span><span class="token punctuation">(</span><span class="token parameter">txt<span class="token operator">:</span> <span class="token builtin">string</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> txt<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex">/\n/g</span><span class="token punctuation">,</span> <span class="token string">&quot;&lt;br /&gt;&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex">/[\|｜](.+?)《(.+?)》/g</span><span class="token punctuation">,</span> <span class="token string">'&lt;ruby&gt;$1&lt;rt&gt;$2&lt;/rt&gt;&lt;/ruby&gt;'</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex">/[\|｜](.+?)（(.+?)）/g</span><span class="token punctuation">,</span> <span class="token string">'&lt;ruby&gt;$1&lt;rt&gt;$2&lt;/rt&gt;&lt;/ruby&gt;'</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex">/[\|｜](.+?)\((.+?)\)/g</span><span class="token punctuation">,</span> <span class="token string">'&lt;ruby&gt;$1&lt;rt&gt;$2&lt;/rt&gt;&lt;/ruby&gt;'</span><span class="token punctuation">)</span>
    <span class="token comment">/* 漢字の連続の後に括弧が存在した場合、一連の漢字をベーステキスト、括弧内の文字をルビテキストとします。 */</span>
    <span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex">/([一-龠]+)《(.+?)》/g</span><span class="token punctuation">,</span> <span class="token string">'&lt;ruby&gt;$1&lt;rt&gt;$2&lt;/rt&gt;&lt;/ruby&gt;'</span><span class="token punctuation">)</span>
    <span class="token comment">/* ただし丸括弧内の文字はひらがなかカタカナのみを指定できます。 */</span>
    <span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex">/([一-龠]+)（([ぁ-んァ-ヶ]+?)）/g</span><span class="token punctuation">,</span> <span class="token string">'&lt;ruby&gt;$1&lt;rt&gt;$2&lt;/rt&gt;&lt;/ruby&gt;'</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex">/([一-龠]+)\(([ぁ-んァ-ヶ]+?)\)/g</span><span class="token punctuation">,</span> <span class="token string">'&lt;ruby&gt;$1&lt;rt&gt;$2&lt;/rt&gt;&lt;/ruby&gt;'</span><span class="token punctuation">)</span>
    <span class="token comment">/* 括弧を括弧のまま表示したい場合は、括弧の直前に縦棒を入力します。 */</span>
    <span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex">/[\|｜]《(.+?)》/g</span><span class="token punctuation">,</span> <span class="token string">'《$1》'</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex">/[\|｜]（(.+?)）/g</span><span class="token punctuation">,</span> <span class="token string">'（$1）'</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex">/[\|｜]\((.+?)\)/g</span><span class="token punctuation">,</span> <span class="token string">'($1)'</span><span class="token punctuation">)</span>
    <span class="token comment">/* 二重山括弧内を傍点付き文字列に変換する */</span>
    <span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex">/《《(.+?)》》/g</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">match<span class="token punctuation">,</span> p1<span class="token punctuation">,</span> offset<span class="token punctuation">,</span> <span class="token builtin">string</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">var</span> boten <span class="token operator">=</span> <span class="token string">&quot;﹅&quot;</span><span class="token punctuation">.</span><span class="token function">repeat</span><span class="token punctuation">(</span>p1<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token string">&quot;&lt;ruby&gt;&quot;</span> <span class="token operator">+</span>p1<span class="token operator">+</span> <span class="token string">&quot;&lt;rt&gt;&quot;</span> <span class="token operator">+</span> boten <span class="token operator">+</span> <span class="token string">&quot;&lt;/rt&gt;&lt;/ruby&gt;&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>でやっています。<br>
カクヨムだと傍点の画像があるっぽいんですけど、ここはめんどくさいので「ぼうてん」で変換して出てくるこいつ <code>﹅</code> を文字数分ルビとして振っています。<br>
このコード（傍点以前）たしかインターネットのどこかからコピペしたもののはずですが、元がどこだったか見つからない……。同じサイトからコピペしてるらしい記事はいくつか出るんですが、少なくとも昨年5月よりは前のはずなので（昨年5月に別のコードに書き付けている）どれも違う。どこだったかメモっておくべきだった……。</p> <h2 id="感想"><a href="#感想" class="header-anchor">#</a> 感想</h2> <p>TypeScriptで書かれているので変数の型がわかりやすく、APIドキュメントをたどりやすくて助かりました。これいいな。<br>
ここからgithubで文章保存して何ならPDFも直接吐きたい。マークダウンをPDFにする拡張はあるっぽいのでやろうと思えばいけるのでは。</p> <h2 id="で、"><a href="#で、" class="header-anchor">#</a> で、</h2> <p>作ったはいいんですけど、これもしかして公開しないと使えないんですかね。毎回デバッグから開くのは嫌なんですけど。</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><!----> <span class="next"><a href="/blog/vue/vuepress.html">VuePress</a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/blog/assets/js/app.83bf8f63.js" defer></script><script src="/blog/assets/js/2.7cd08314.js" defer></script><script src="/blog/assets/js/9.2516a79e.js" defer></script><script src="/blog/assets/js/3.09c30569.js" defer></script>
  </body>
</html>
